// ===== Telegram WebApp init =====
const tg = window.Telegram?.WebApp || null;

if (tg) {
  tg.ready();
  tg.expand();
}

const tgUser = tg?.initDataUnsafe?.user || null;

// –¢–≤–æ–π Telegram user id (–≤–ª–∞–¥–µ–ª–µ—Ü)
const OWNER_TG_ID = 658384304;

// ===== Global state =====
let role = null;

// ===== Demo data =====
const data = {
  stats: {
    total: 150,
    active: 130,
    repair: 10,
    idle: 10,
    accident: 3,
    repairLoss: "459 000", // –±–µ–∑ ‚ÇΩ
    idleLoss: "35 000",    // –±–µ–∑ ‚ÇΩ
    deposits: "350 000"    // –¥–µ–ø–æ–∑–∏—Ç –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
  },
  cars: [
    { number: "K526CA78", model: "Volkswagen Polo", driver: "–Æ—Ä–∏–π –ò–≤–∞–Ω–æ–≤", status: "–í —Ä–µ–º–æ–Ω—Ç–µ", days: 12, loss: "–ü–æ—Ç–µ—Ä–∏", deposit: "‚Äî" },
    { number: "A102BC77", model: "Hyundai Solaris", driver: "–ê—Ä—Ç—ë–º –ö—É–∑–Ω–µ—Ü–æ–≤", status: "–ù–∞ –ª–∏–Ω–∏–∏", days: 0, loss: "‚Äî", deposit: "10 000" },
    { number: "M883PK98", model: "Kia Rio", driver: "–°–µ—Ä–≥–µ–π –ü–µ—Ç—Ä–æ–≤", status: "–í –ø—Ä–æ—Å—Ç–æ–µ", days: 7, loss: "–µ—Å—Ç—å", deposit: "8 000" },
    { number: "T441OO78", model: "Skoda Rapid", driver: "–î–º–∏—Ç—Ä–∏–π –°–º–∏—Ä–Ω–æ–≤", status: "–ù–∞ –ª–∏–Ω–∏–∏", days: 0, loss: "‚Äî", deposit: "12 000" },
    { number: "E909KK99", model: "Renault Logan", driver: "–ò–ª—å—è –§—ë–¥–æ—Ä–æ–≤", status: "–í —Ä–µ–º–æ–Ω—Ç–µ", days: 3, loss: "–µ—Å—Ç—å", deposit: "‚Äî" },
    { number: "P120TT98", model: "Lada Granta", driver: "–ù–∏–∫–∏—Ç–∞ –û—Ä–ª–æ–≤", status: "–ù–∞ –ª–∏–Ω–∏–∏", days: 0, loss: "‚Äî", deposit: "5 000" },
    { number: "C777MM78", model: "Chery Tiggo 4", driver: "–ê–ª–µ–∫—Å–µ–π –í–æ–ª–∫–æ–≤", status: "–í –ø—Ä–æ—Å—Ç–æ–µ", days: 10, loss: "–µ—Å—Ç—å", deposit: "15 000" }
  ]
};

// ===== Screens =====
function showScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  const el = document.getElementById(id);
  if (el) el.classList.add("active");
}

// ===== Auto-role for owner (if open from Telegram and id matches) =====
function detectRoleByTelegram() {
  if (!tgUser) return null;
  const uid = Number(tgUser.id);
  if (uid === Number(OWNER_TG_ID)) return "owner";
  return null; // –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤—ã–±–∏—Ä–∞–µ–º –≤—Ä—É—á–Ω—É—é
}

// –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ: –µ—Å–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü ‚Äî —Å—Ä–∞–∑—É –≤ Home
(function init() {
  const autoRole = detectRoleByTelegram();
  if (autoRole) {
    role = autoRole;
    showScreen("homeScreen");
    renderHome();
  } else {
    showScreen("roleScreen");
  }
})();

// ===== Role selection =====
window.setRole = function (selectedRole) {
  role = selectedRole;
  showScreen("homeScreen");
  renderHome();
};

// ===== Home render =====
function renderHome() {
  const title = document.getElementById("welcomeTitle");
  title.innerText =
    role === "owner" ? "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –≤–ª–∞–¥–µ–ª–µ—Ü" :
    role === "manager" ? "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –º–µ–Ω–µ–¥–∂–µ—Ä" :
    "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –º–µ—Ö–∞–Ω–∏–∫";

  // --- stats ---
  const stats = document.getElementById("stats");
  stats.innerHTML = `
    <div class="card">üöò –ê–≤—Ç–æ –≤—Å–µ–≥–æ: ${data.stats.total}</div>
    <div class="card">üü¢ –ù–∞ –ª–∏–Ω–∏–∏: ${data.stats.active}</div>
    <div class="card">üîß –í —Ä–µ–º–æ–Ω—Ç–µ: ${data.stats.repair}</div>
    <div class="card">‚è∏ –í –ø—Ä–æ—Å—Ç–æ–µ: ${data.stats.idle}</div>
    <div class="card">‚ö†Ô∏è –î–¢–ü –∑–∞ –Ω–µ–¥–µ–ª—é: ${data.stats.accident}</div>
  `;

  // --- finance ---
  const finance = document.getElementById("finance");
  finance.innerHTML = "";

  if (role === "owner") {
    finance.innerHTML = `
      <div class="card">üîß –ü–æ—Ç–µ—Ä–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç–µ: -${data.stats.repairLoss}</div>
      <div class="card">üö´ –ü–æ—Ç–µ—Ä–∏ –Ω–∞ –ø—Ä–æ—Å—Ç–æ–µ: -${data.stats.idleLoss}</div>
      <div class="card">üí≥ –î–µ–ø–æ–∑–∏—Ç—ã: ${data.stats.deposits}</div>
    `;
  } else if (role === "manager") {
    finance.innerHTML = `
      <div class="card">üîß –ü–æ—Ç–µ—Ä–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç–µ: –µ—Å—Ç—å</div>
      <div class="card">üö´ –ü–æ—Ç–µ—Ä–∏ –Ω–∞ –ø—Ä–æ—Å—Ç–æ–µ: –µ—Å—Ç—å</div>
      <div class="card">üí≥ –î–µ–ø–æ–∑–∏—Ç—ã: –µ—Å—Ç—å</div>
    `;
  } else {
    // mechanic ‚Äî —Ñ–∏–Ω–∞–Ω—Å—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    finance.innerHTML = "";
  }
}

// ===== Navigation =====
window.goTo = function (screen) {
  showScreen(screen);
  if (screen === "carsScreen") renderCars();
};

window.logout = function () {
  role = null;
  showScreen("roleScreen");
};

// ===== Cars list =====
function renderCars() {
  const el = document.getElementById("carsList");
  el.innerHTML = data.cars.map => `
    <div class="card">
      üöó <b>${car.number}</b> ‚Äî ${car.model}

      <div style="opacity:.85; margin-top:6px;">
        –°—Ç–∞—Ç—É—Å: ${car.status}

        –ü—Ä–æ—Å—Ç–æ–π: ${car.days} –¥–Ω–µ–π
      </div>
    </div>
  `).join("");
}(car
